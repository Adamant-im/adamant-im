<template>
  <div :class="classes.root">
    <app-toolbar-centered app :title="$t('options.wallets_list')" :show-back="true" flat fixed />

    <v-container fluid class="px-0 container--with-app-toolbar">
      <v-row justify="center" no-gutters>
        <container padding>
          <WalletsSearchInput @change="searchChanged"></WalletsSearchInput>
          <v-list lines="one">
            <draggable
              class="list-group"
              v-model="filteredWallets"
              v-bind="dragOptions"
              handle=".handle"
              @start="isDragging = true"
              @end="isDragging = false"
              item-key="cryptoName"
            >
              <template #item="{ element }">
                <WalletsListItem :wallet="element" :search="search"></WalletsListItem>
              </template>
            </draggable>
            <v-list-item>
              <WalletResetDialog></WalletResetDialog>
            </v-list-item>
          </v-list>
        </container>
      </v-row>
    </v-container>
  </div>
</template>

<script lang="ts">
import draggable from 'vuedraggable'
import AppToolbarCentered from '@/components/AppToolbarCentered.vue'
import { computed, defineComponent, onBeforeUnmount, ref } from 'vue'
import { CryptosInfo, CryptoSymbol, isErc20 } from '@/lib/constants'
import { useStore } from 'vuex'
import WalletsSearchInput from '@/components/wallets/WalletsSearchInput.vue'
import WalletsListItem from '@/components/wallets/WalletsListItem.vue'
import WalletResetDialog from '@/components/wallets/WalletResetDialog.vue'
import { Timer } from 'web3-utils'

const BALANCE_UPDATE_INTERVAL_MS = 30000

const className = 'wallets-view'
const classes = {
  root: className
}

const dragOptions = {
  animation: 200,
  disabled: false,
  ghostClass: 'ghost',
  group: 'description'
}

type OrderedWalletSymbol = {
  isVisible: boolean
  symbol: CryptoSymbol
}

type Wallet = {
  erc20?: boolean
  balance?: number
  cryptoName?: string
  currentRate?: number
  isVisible: boolean
  key?: string
  rate?: number
  symbol: CryptoSymbol
  type?: string
}

export default defineComponent({
  components: {
    WalletResetDialog,
    WalletsListItem,
    WalletsSearchInput,
    AppToolbarCentered,
    draggable
  },
  setup() {
    const store = useStore()

    const isDragging = ref(false)
    const search = ref('')

    const orderedAllWalletSymbols = computed(() => {
      return store.getters['wallets/getAllOrderedWalletSymbols']
    })

    const wallets = computed(() => {
      return orderedAllWalletSymbols.value.map((crypto: OrderedWalletSymbol) => {
        const symbol = crypto.symbol
        const cryptoName = CryptosInfo[symbol].nameShort || CryptosInfo[symbol].name
        const erc20 = isErc20(symbol)
        const isVisible = crypto.isVisible
        const type = CryptosInfo[symbol].type ?? 'Blockchain'

        return {
          cryptoName,
          erc20,
          isVisible,
          symbol,
          type
        }
      })
    })

    const searchChanged = (value: string | Event) => {
      if (value instanceof Event) return
      search.value = value
    }

    const filteredWallets = computed({
      get() {
        return wallets.value.filter((wallet: Wallet) => {
          return (
            wallet.cryptoName?.toLowerCase().includes(search.value.toLowerCase()) ||
            wallet.symbol.toLowerCase().includes(search.value.toLowerCase())
          )
        })
      },
      set(value) {
        const mappedValue = value.map((item: Wallet) => {
          return {
            symbol: item.symbol,
            isVisible: item.isVisible
          }
        })

        store.dispatch('wallets/setWalletSymbolsTemplates', mappedValue)
      }
    })

    const timer = ref<Timer>(setInterval(() => updateBalances(), BALANCE_UPDATE_INTERVAL_MS))

    const updateBalances = () => {
      store.dispatch('updateBalance', {
        requestedByUser: true
      })
    }

    onBeforeUnmount(() => {
      clearInterval(timer.value)
    })

    return {
      classes,
      dragOptions,
      filteredWallets,
      isDragging,
      search,
      searchChanged,
      wallets
    }
  }
})
</script>

<style lang="scss" scoped></style>
